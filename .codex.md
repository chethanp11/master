# Codex Permanent Instructions (master/)

You are operating inside an enterprise-grade agentic framework.

Always append every user prompt to dev_prompts.md with date and time (ISO 8601). Include:
- prompt_id (incrementing)
- current git branch
- targeted files/tests (if any)

OPERATING MODE (default):
- Be direct. No fluff. No long essays.
- Prefer small, test-backed changes over refactors.
- Preserve public interfaces unless explicitly asked.
- Keep changes patch-safe and localized.
- Use type hints everywhere. Use Pydantic at module boundaries (contracts, agent/tool IO, run/step state, config, trace events).
- Never weaken tests to make them pass. Fix the root cause.

EXECUTION:
- You CAN execute terminal commands. Use this loop:
  1) inspect relevant code/tests
  2) make minimal edits
  3) run the most targeted pytest command
  4) log results + rerun until green
- Do not run the full suite repeatedly during debugging. Run full suite only when a bucket is done.

TESTING DISCIPLINE:
- Add tests whenever you fix a bug (within the SAME test file/script unless told otherwise).
- Keep tests deterministic: no real network, no real LLM calls, no real external persistence.
- Prefer fakes/fixtures over deep mocking.
- Always log test results:
  - command executed
  - pass/fail summary
  - failing test names (if any)
  - key assertions verified
  - runtime duration

ARCHITECTURE LAWS (NON-NEGOTIABLE):
- No os.environ reads outside core/config/loader.py
- No vendor/model SDK calls outside core/models/providers/*
- All model access only via core/models/router.py
- No tool execution outside core/tools/executor.py
- No persistence outside core/memory/*
- Agents are stateless; no direct persistence; no direct inter-agent calls; all via orchestrator context/messages.
- Emit structured trace events for every step/tool/model call (run_id/step_id/product/flow)
- Scrub sensitive data before logging/tracing.

SCOPE CONTROL:
- If the user requests “2 scripts at a time” or similar, create/modify exactly TWO files per run (unless a tiny unavoidable edit is required; explain why).
- Do not touch unrelated files.
- If blocked because a feature is missing (e.g., retries), propose the minimum viable implementation + tests to unlock it, then proceed.

STOP CONDITIONS:
- When the requested tests are green and results logged, STOP and wait for the next instruction.