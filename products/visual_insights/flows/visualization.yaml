# ==============================
# Flow: overview
# ==============================
# Golden path:
#   1) Read dataset summary
#   2) Agent produces dashboard narrative

id: "visualization"
version: "1.0.0"
description: "Data reader -> approval -> dashboard agent summary"
autonomy_level: "suggest_only"

steps:
  - id: "plan"
    type: "agent"
    backend: "local"
    agent: "planning_agent"
    params: {}

  - id: "read"
    type: "tool"
    backend: "local"
    tool: "data_reader"
    params:
      dataset: "{{payload.dataset}}"
    retry:
      max_attempts: 2
      backoff_seconds: 1

  - id: "detect_anomalies"
    type: "tool"
    backend: "local"
    tool: "detect_anomalies"
    params:
      series: "{{artifacts.tool.data_reader.output.series}}"
      data: "{{artifacts.tool.data_reader.output.data}}"
      min_points: 3

  - id: "recommend_chart"
    type: "tool"
    backend: "local"
    tool: "recommend_chart"
    params:
      intent: "{{payload.prompt}}"
      has_time: "{{artifacts.tool.data_reader.output.has_time}}"
      has_category: "{{artifacts.tool.data_reader.output.has_category}}"
      has_x_numeric: "{{artifacts.tool.data_reader.output.has_x_numeric}}"
      has_y_numeric: "{{artifacts.tool.data_reader.output.has_y_numeric}}"
      wants_composition: false

  - id: "summarize"
    type: "agent"
    backend: "local"
    agent: "dashboard_agent"
    params:
      template: "Dashboard summary: {summary}"

  - id: "llm_review"
    type: "agent"
    backend: "local"
    agent: "llm_reasoner"
    params:
      purpose: "reasoning"
      prompt: "Write a concise narrative for the dashboard. Dataset: {{artifacts.tool.data_reader.output.summary}}. Anomalies: {{artifacts.tool.detect_anomalies.output.summary}} (details: {{artifacts.tool.detect_anomalies.output.anomalies}}). Chart: {{artifacts.tool.recommend_chart.output.chart_type}}. Mention at least one concrete pattern if present."
      max_tokens: 200

  - id: "approval"
    type: "human_approval"
    title: "Approve visualization inputs"
    message: "Approve the dataset summary before generating visuals."
    params:
      approval_context:
        reason: "Approve dataset summary and chart recommendation before building visuals."
        decision_notes:
          - "Dataset parsed and summarized."
          - "Anomaly check completed."
          - "Chart recommendation computed."
        recommended_action: "APPROVE"
    form:
      fields:
        - name: "approved"
          type: "boolean"
          required: true
        - name: "notes"
          type: "string"
          required: false

  - id: "build_chart_spec"
    type: "tool"
    backend: "local"
    tool: "build_chart_spec"
    params:
      chart_type: "{{artifacts.tool.recommend_chart.output.chart_type}}"
      title: "Visualization for {{payload.dataset}}"
      x: "{{artifacts.tool.data_reader.output.x_field}}"
      y: "{{artifacts.tool.data_reader.output.y_field}}"
      series: "{{artifacts.tool.data_reader.output.category_field}}"
      data: "{{artifacts.tool.data_reader.output.data}}"

  - id: "assemble_card"
    type: "tool"
    backend: "local"
    tool: "assemble_insight_card"
    params:
      card_id: "card_1"
      title: "Visualization for {{payload.dataset}}"
      chart_type: "{{artifacts.tool.recommend_chart.output.chart_type}}"
      chart_spec: "{{artifacts.tool.build_chart_spec.output.chart_spec}}"
      narrative: "{{artifacts.agent.llm_reasoner.output.content}}"
      anomaly_summary: "{{artifacts.tool.detect_anomalies.output.summary}}"
      anomalies: "{{artifacts.tool.detect_anomalies.output.anomalies}}"
      key_metrics:
        - name: "row_count"
          value: "{{artifacts.tool.data_reader.output.row_count}}"
      citations:
        - type: "csv"
          csv:
            dataset_id: "{{payload.dataset}}"
            columns: "{{artifacts.tool.data_reader.output.columns}}"
            filters: []
      assumptions:
        - "Chart generated from uploaded dataset."

  - id: "approval_export"
    type: "human_approval"
    title: "Approve export"
    message: "Approve exporting the visualization."
    params:
      approval_context:
        reason: "Approve exporting the visualization output."
        decision_notes:
          - "Chart spec built."
          - "Insight card assembled."
          - "Export will generate PDF and stub."
        recommended_action: "APPROVE"
    form:
      fields:
        - name: "approved"
          type: "boolean"
          required: true
        - name: "notes"
          type: "string"
          required: false

  - id: "export"
    type: "tool"
    backend: "local"
    tool: "export_pdf"
    params:
      cards:
        - "{{artifacts.tool.assemble_insight_card.output.card}}"
      export_requested: true
